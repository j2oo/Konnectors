// Generated by CoffeeScript 1.10.0
var Consumption, File, cheerio, cozydb, fetcher, fs, localization, log, logIn, moment, parsePage, request;

cozydb = require('cozydb');

request = require('request');

moment = require('moment');

cheerio = require('cheerio');

fs = require('fs');

File = require('../models/file');

fetcher = require('../lib/fetcher');

localization = require('../lib/localization_manager');

log = require('printit')({
  prefix: "VeoliaEau",
  date: true
});

Consumption = cozydb.getModel('Consumption', {
  date: Date,
  vendor: String,
  target: String,
  meter: Number,
  unit: String,
  period: String,
  estimated: {
    type: Boolean,
    "default": false
  }
});

Consumption.all = function(callback) {
  return Consumption.request('byDate', callback);
};

module.exports = {
  name: "VeoliaEau",
  slug: "veolia",
  description: 'konnector description VeoliaEau',
  vendorLink: "https://www.service-client.veoliaeau.fr/",
  fields: {
    login: "text",
    password: "password",
    target: "text"
  },
  models: {
    consumption: Consumption
  },
  init: function(callback) {
    var map;
    map = function(doc) {
      return emit(doc.date, doc);
    };
    return Consumption.defineRequest('byDate', map, function(err) {
      return callback(err);
    });
  },
  fetch: function(requiredFields, callback) {
    log.info("Import started");
    return fetcher["new"]().use(logIn).use(parsePage).args(requiredFields, {}, {}).fetch(function(err, fields, entries) {
      var localizationKey, notifContent, options, ref;
      log.info("Import finished");
      notifContent = null;
      if ((entries != null ? (ref = entries.filtered) != null ? ref.length : void 0 : void 0) > 0) {
        localizationKey = 'notification VeoliaEau';
        options = {
          smart_count: entries.filtered.length
        };
        notifContent = localization.t(localizationKey, options);
      }
      return callback(err, notifContent);
    });
  }
};

logIn = function(requiredFields, consumptionInfos, data, next) {
  var ConsumptionUrl, GetConsumptionUrl, form, loginUrl, options;
  loginUrl = "https://www.service-client.veoliaeau.fr/home/connexion-espace-client.loginAction.do";
  ConsumptionUrl = "https://www.service-client.veoliaeau.fr/home/espace-client/votre-consommation.updateReleveGraph.do";
  GetConsumptionUrl = "https://www.service-client.veoliaeau.fr/home/espace-client/votre-consommation.html?vueConso=releves";
  form = {
    "veolia_password": requiredFields.password,
    "veolia_username": requiredFields.login
  };
  options = {
    method: 'POST',
    form: form,
    jar: true,
    url: loginUrl
  };
  log.info("Before logIn");
  return request(options, function(err, res, body) {
    var isError, isNoLocation, isNot302, location, parameters, url;
    isNoLocation = res.headers.location == null;
    isNot302 = res.statusCode !== 302;
    isError = (res.headers.location != null) && res.headers.location.indexOf("error") !== -1;
    if (err || isNoLocation || isNot302 || isError) {
      log.error("Authentification error");
      return next('bad credentials');
    } else {
      log.info("logIn OK");
      form = {
        vueConso: "releves",
        periode_releve: "jour",
        dateDeb_releve: "",
        moisDeb_releve: "01/04/2015",
        dateFin_releve: "",
        moisFin_releve: "01/03/2016",
        donnee_releve: "donn√©es",
        mesure_releve: "m3",
        btnAfficher_releve: "",
        veoliaFormName: "formulaireConso_releve",
        veoliaFormValue: "null"
      };
      options = {
        method: 'POST',
        form: form,
        jar: true,
        url: ConsumptionUrl
      };
      request(options, function(err, res, body) {
        isNoLocation = res.headers.location == null;
        isNot302 = res.statusCode !== 302;
        return isError = (res.headers.location != null) && res.headers.location.indexOf("error") !== -1;
      });
      if (err || isNoLocation || isNot302 || isError) {
        log.error("Authentification error");
        return next('bad credentials');
      } else {
        log.info("ConsumptionUrl OK");
        location = res.headers.location;
        parameters = location.split('?')[1];
        url = GetConsumptionUrl + "?" + parameters;
        return request.get(url, function(err, res, body) {
          if (err) {
            return next(err);
          } else {
            log.info("GetConsumption OK");
            data.html = body;
            return next();
          }
        });
      }
    }
  });
};

parsePage = function(requiredFields, comsumption, data, next) {
  var $;
  consumption.fetched = [];
  if (data.html == null) {
    return next();
  }
  $ = cheerio.load(data.html);
  $('table.table_box3 tbody tr').each(function() {
    var consumption;
    log.info("Content $$(this).html()");
    return consumption = {
      date: moment('01/04/2016'),
      vendor: 'VeoliaEau',
      target: 'Test',
      meter: 333.12,
      unit: 'm3',
      estimated: true
    };
  });
  return next();
};
